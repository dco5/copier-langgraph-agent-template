"""
Integration tests for API endpoints.
"""

import pytest
from httpx import AsyncClient


class TestHealthEndpoints:
    """Tests for health check endpoints."""

    @pytest.mark.asyncio
    async def test_root_endpoint(self, client: AsyncClient):
        """Test root endpoint returns service info."""
        response = await client.get("/")

        assert response.status_code == 200
        data = response.json()
        assert "service" in data
        assert "version" in data
        assert "health" in data

    @pytest.mark.asyncio
    async def test_health_check(self, client: AsyncClient):
        """Test health check endpoint."""
        response = await client.get("/health")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] in ["healthy", "degraded"]
        assert "environment" in data

    @pytest.mark.asyncio
    async def test_liveness_probe(self, client: AsyncClient):
        """Test Kubernetes liveness probe."""
        response = await client.get("/health/live")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "alive"


class TestAgentEndpoints:
    """Tests for agent API endpoints."""

    @pytest.mark.asyncio
    async def test_list_agents(self, client: AsyncClient):
        """Test listing available agents."""
        response = await client.get("/api/v1/agents/list")

        assert response.status_code == 200
        agents = response.json()
        assert isinstance(agents, list)
        assert "{{ agent_name }}" in agents

    @pytest.mark.asyncio
    async def test_agents_info(self, client: AsyncClient):
        """Test getting agents information."""
        response = await client.get("/api/v1/agents/info")

        assert response.status_code == 200
        data = response.json()
        assert "agents" in data
        assert "{{ agent_name }}" in data["agents"]
        assert "default_agent" in data

    @pytest.mark.asyncio
    async def test_invoke_unknown_agent(self, client: AsyncClient):
        """Test invoking unknown agent returns 404."""
        response = await client.post(
            "/api/v1/agents/unknown_agent/invoke",
            json={"message": "Hello"},
        )

        assert response.status_code == 404


{%- if use_auth %}


class TestAuthEndpoints:
    """Tests for authentication endpoints."""

    @pytest.mark.asyncio
    async def test_register(self, client: AsyncClient):
        """Test user registration."""
        response = await client.post(
            "/api/v1/auth/register",
            json={
                "email": "test@example.com",
                "password": "testpassword123",
                "name": "Test User",
            },
        )

        assert response.status_code == 201
        data = response.json()
        assert "user" in data
        assert "tokens" in data
        assert data["user"]["email"] == "test@example.com"

    @pytest.mark.asyncio
    async def test_register_invalid_email(self, client: AsyncClient):
        """Test registration with invalid email."""
        response = await client.post(
            "/api/v1/auth/register",
            json={
                "email": "invalid-email",
                "password": "testpassword123",
            },
        )

        assert response.status_code == 422  # Validation error

    @pytest.mark.asyncio
    async def test_register_short_password(self, client: AsyncClient):
        """Test registration with short password."""
        response = await client.post(
            "/api/v1/auth/register",
            json={
                "email": "test@example.com",
                "password": "short",
            },
        )

        assert response.status_code == 422  # Validation error

    @pytest.mark.asyncio
    async def test_login(self, client: AsyncClient):
        """Test user login."""
        response = await client.post(
            "/api/v1/auth/login",
            json={
                "email": "test@example.com",
                "password": "testpassword123",
            },
        )

        assert response.status_code == 200
        data = response.json()
        assert "tokens" in data
        assert "access_token" in data["tokens"]
        assert "refresh_token" in data["tokens"]

    @pytest.mark.asyncio
    async def test_logout_unauthorized(self, client: AsyncClient):
        """Test logout without authentication."""
        response = await client.post("/api/v1/auth/logout")

        assert response.status_code == 401
{%- endif %}


{%- if use_prometheus %}


class TestMetricsEndpoint:
    """Tests for Prometheus metrics endpoint."""

    @pytest.mark.asyncio
    async def test_metrics(self, client: AsyncClient):
        """Test metrics endpoint returns Prometheus format."""
        response = await client.get("/metrics")

        assert response.status_code == 200
        assert "text/plain" in response.headers["content-type"]
        # Check for some expected metrics
        assert "http_requests_total" in response.text or "{{ _package_name }}" in response.text
{%- endif %}
