"""{{ project_name }} - Streamlit Chat Interface."""

import streamlit as st
import httpx
import asyncio
import json

st.set_page_config(
    page_title="{{ project_name }}",
    page_icon="ðŸ¤–",
    layout="wide",
)

# Configuration
API_BASE_URL = "http://localhost:8000"
AGENT_NAME = "{{ agent_name }}"


def init_session_state():
    """Initialize session state variables."""
    if "messages" not in st.session_state:
        st.session_state.messages = []
    if "thread_id" not in st.session_state:
        st.session_state.thread_id = None


async def invoke_agent(message: str, thread_id: str | None = None) -> dict:
    """Call the agent API."""
    async with httpx.AsyncClient() as client:
        response = await client.post(
            f"{API_BASE_URL}/api/v1/agents/{AGENT_NAME}/invoke",
            json={
                "message": message,
                "thread_id": thread_id,
            },
            timeout=60.0,
        )
        response.raise_for_status()
        return response.json()


async def stream_agent(message: str, thread_id: str | None = None):
    """Stream agent response."""
    async with httpx.AsyncClient() as client:
        async with client.stream(
            "POST",
            f"{API_BASE_URL}/api/v1/agents/{AGENT_NAME}/stream",
            json={
                "message": message,
                "thread_id": thread_id,
            },
            timeout=60.0,
        ) as response:
            response.raise_for_status()
            async for line in response.aiter_lines():
                if line.startswith("data: "):
                    try:
                        data = json.loads(line[6:])
                        if "content" in data:
                            yield data["content"]
                    except json.JSONDecodeError:
                        continue


def main():
    """Main Streamlit app."""
    init_session_state()

    # Header
    st.title("ðŸ¤– {{ project_name }}")
    st.caption("{{ project_description }}")

    # Sidebar
    with st.sidebar:
        st.header("Settings")

        # Thread management
        if st.button("New Conversation"):
            st.session_state.messages = []
            st.session_state.thread_id = None
            st.rerun()

        if st.session_state.thread_id:
            st.text(f"Thread: {st.session_state.thread_id[:8]}...")

        st.divider()

        # Streaming toggle
        use_streaming = st.checkbox("Enable streaming", value=True)

        st.divider()
        st.markdown("**API Status**")
        try:
            with httpx.Client() as client:
                health = client.get(f"{API_BASE_URL}/health", timeout=5.0)
                if health.status_code == 200:
                    st.success("Connected")
                else:
                    st.warning("Degraded")
        except Exception:
            st.error("Disconnected")

    # Chat history
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # Chat input
    if prompt := st.chat_input("Type your message..."):
        # Add user message
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # Get agent response
        with st.chat_message("assistant"):
            if use_streaming:
                # Streaming response
                response_placeholder = st.empty()
                full_response = ""

                async def stream_response():
                    nonlocal full_response
                    async for token in stream_agent(
                        prompt, st.session_state.thread_id
                    ):
                        full_response += token
                        response_placeholder.markdown(full_response + "â–Œ")
                    response_placeholder.markdown(full_response)

                asyncio.run(stream_response())
            else:
                # Non-streaming response
                with st.spinner("Thinking..."):
                    result = asyncio.run(
                        invoke_agent(prompt, st.session_state.thread_id)
                    )
                    full_response = result["content"]
                    st.session_state.thread_id = result.get("thread_id")
                    st.markdown(full_response)

            st.session_state.messages.append(
                {"role": "assistant", "content": full_response}
            )


if __name__ == "__main__":
    main()
